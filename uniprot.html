<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UniProt Protein/Gene Search</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    input, select, button { margin-top: 5px; padding: 5px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    #organismList { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; position: absolute; background: #fff; width: 250px; }
    #organismList div { padding: 5px; cursor: pointer; }
    #organismList div:hover { background-color: #eee; }
    .link { color: #0969da; text-decoration: none; }
    .link:hover { text-decoration: underline; }
    .muted { color: #666; }
  </style>
</head>
<body>
  <h1>Search UniProt by Protein or Gene</h1>
  
  <form id="searchForm">
    <label>
      Search Term:
      <input type="text" id="query" required>
    </label>
    <label>
      Search Field:
      <select id="field">
        <option value="gene">Gene Name</option>
        <option value="protein">Protein Name</option>
      </select>
    </label>
    <label style="position:relative;">
      Organism:
      <input type="text" id="organism" autocomplete="off">
      <div id="organismList" style="display:none;"></div>
    </label>
    <button type="submit">Search</button>
  </form>
  
  <table id="resultsTable" style="display:none;">
    <thead>
      <tr>
        <th>UniProt ID</th>
        <th>Protein Name</th>
        <th>Gene Name</th>
        <th>Organism</th>
        <th>PDB Structures (Grouped by Position)</th>
      </tr>
    </thead>
    <tbody id="resultsBody"></tbody>
  </table>
  
  <script>
    const organismInput = document.getElementById('organism');
    const organismList = document.getElementById('organismList');
    let selectedOrganismId = "";

    // Autocomplete for organisms
    organismInput.addEventListener('input', async function() {
      const term = organismInput.value.trim();
      selectedOrganismId = ""; // reset if user types manually
      if (!term) { organismList.style.display = "none"; return; }
      
      const url = `https://rest.uniprot.org/taxonomy/search?query=${encodeURIComponent(term)}&size=10&format=json`;
      const response = await fetch(url);
      const data = await response.json();
      
      organismList.innerHTML = "";
      (data.results || []).forEach(org => {
        const div = document.createElement('div');
        // ✅ use org.taxonId
        div.textContent = `${org.scientificName} (ID: ${org.taxonId})`;
        div.onclick = () => {
          organismInput.value = org.scientificName;
          selectedOrganismId = org.taxonId;   // ✅ store taxonomy ID correctly
          organismList.style.display = "none";
        };
        organismList.appendChild(div);
      });
      organismList.style.display = "block";
    });

    document.getElementById('searchForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const query = document.getElementById('query').value;
      const field = document.getElementById('field').value;
      
      let searchField = field === "gene" ? `gene:${query}` : `protein_name:${query}`;
      let url = `https://rest.uniprot.org/uniprotkb/search?query=${encodeURIComponent(searchField)}`;
      
      // ✅ Apply organism filter if chosen
      if (selectedOrganismId) {
        url += `+AND+organism_id:${selectedOrganismId}`;
      }
      url += "&format=json&size=5";
      
      const response = await fetch(url);
      const data = await response.json();
      
      const resultsBody = document.getElementById('resultsBody');
      resultsBody.innerHTML = "";
      
      data.results.forEach(entry => {
        const uniId = entry.primaryAccession;
        const uniLink = `https://www.uniprot.org/uniprotkb/${uniId}`;
        const proteinName = entry.proteinDescription?.recommendedName?.fullName?.value || "N/A";
        const geneName = entry.genes?.[0]?.geneName?.value || "N/A";
        const organismName = entry.organism?.scientificName || "N/A";
        
        // Collect all PDBs for this UniProt
        const pdbRefs = (entry.uniProtKBCrossReferences || []).filter(ref => ref.database === "PDB");

        // ✅ Group by chain/position
        const grouped = {};
        pdbRefs.forEach(ref => {
          const chainPos = (ref.properties || []).find(p => p.key === "Chains")?.value || "Unspecified";
          if (!grouped[chainPos]) grouped[chainPos] = [];
          grouped[chainPos].push(ref.id);
        });

        let pdbListHtml = "";
        if (Object.keys(grouped).length) {
          for (const [pos, pdbIds] of Object.entries(grouped)) {
            const links = pdbIds.map(pdbId => {
              const rcsbLink = `https://www.rcsb.org/structure/${pdbId}`;
              return `<a class="link" href="${rcsbLink}" target="_blank">${pdbId}</a>`;
            }).join(", ");
            pdbListHtml += `<div><strong>${pos}:</strong> ${links}</div>`;
          }
        } else {
          pdbListHtml = `<span class="muted">No PDB structures</span>`;
        }

        const row = `<tr>
          <td><a class="link" href="${uniLink}" target="_blank">${uniId}</a></td>
          <td>${proteinName}</td>
          <td>${geneName}</td>
          <td>${organismName}</td>
          <td>${pdbListHtml}</td>
        </tr>`;
        resultsBody.innerHTML += row;
      });
      
      document.getElementById('resultsTable').style.display = "table";
    });
  </script>
</body>
</html>
