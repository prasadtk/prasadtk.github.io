<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UniProt Protein/Gene Search</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .muted { color: #666; }
    .link { color: #0d6efd; text-decoration: none; }
    .link:hover { text-decoration: underline; }
    .pdb-group { margin-bottom: 8px; }
    .spinner {
      display: inline-block;
      width: 1rem; height: 1rem;
      border: 2px solid #ccc; border-top-color: #0d6efd; border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    pre { margin: 0; }
  </style>
</head>
<body class="container my-4">
  <h1 class="mb-4">UniProt Protein/Gene Search</h1>

  <!-- Search Form and Results Table-->

  <form id="searchForm" class="row g-3">
    <div class="col-md-4">
      <label class="form-label">Search Term</label>
      <input type="text" id="query" class="form-control" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Search Field</label>
      <select id="field" class="form-select">
        <option value="gene">Gene Name</option>
        <option value="protein">Protein Name</option>
      </select>
    </div>
    <div class="col-md-5 position-relative">
      <label class="form-label">Organism (autocomplete)</label>
      <input type="text" id="organism" class="form-control" autocomplete="off">
      <div id="organismList" class="list-group position-absolute w-100" style="z-index:1000; display:none;"></div>
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-primary">Search</button>
    </div>
  </form>
  

  <div class="table-responsive mt-4">
    <table id="resultsTable" class="table table-bordered table-striped d-none">
      <thead class="table-light">
        <tr>
          <th>UniProt ID</th>
          <th>Protein Name</th>
          <th>Gene Name</th>
          <th>Organism</th>
          <th>PDB Structures</th>
          <th>Sequence</th>
          <th>Cross-links</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>




  <!-- Sequence Modal -->
  <div class="modal fade" id="sequenceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Protein Sequence (FASTA)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <pre id="sequenceContent" style="white-space: pre-wrap;"></pre>
        </div>
      </div>
    </div>
  </div>



  <!-- Autocomplete for organisms -->
  
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const organismInput = document.getElementById('organism');
    const organismList = document.getElementById('organismList');
    let selectedOrganismId = "";

    organismInput.addEventListener('input', async function() {
      const term = organismInput.value.trim();
      selectedOrganismId = "";
      if (!term) { organismList.style.display = "none"; return; }
      try {
        const url = `https://rest.uniprot.org/taxonomy/search?query=${encodeURIComponent(term)}&size=10&format=json`;
        const response = await fetch(url);
        const data = await response.json();
        organismList.innerHTML = "";
        (data.results || []).forEach(org => {
          const item = document.createElement('button');
          item.type = "button";
          item.className = "list-group-item list-group-item-action";
          item.textContent = `${org.scientificName} (ID: ${org.taxonId})`;
          item.onclick = () => {
            organismInput.value = org.scientificName;
            selectedOrganismId = org.taxonId;
            organismList.style.display = "none";
          };
          organismList.appendChild(item);
        });
        organismList.style.display = (data.results || []).length ? "block" : "none";
      } catch (err) {
        organismList.style.display = "none";
      }
    });

  <!-- JavaScript (results rendering, sequence modal, and PDB title fetch) -->



    document.getElementById('searchForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const query = document.getElementById('query').value.trim();
      const field = document.getElementById('field').value;
      if (!query) return;

      let searchField = field === "gene" ? `gene:${query}` : `protein_name:${query}`;
      let url = `https://rest.uniprot.org/uniprotkb/search?query=${encodeURIComponent(searchField)}`;
      if (selectedOrganismId) url += `+AND+organism_id:${selectedOrganismId}`;
      url += "&format=json&size=5";

      const resultsBody = document.getElementById('resultsBody');
      resultsBody.innerHTML = `<tr><td colspan="7" class="text-center"><span class="spinner"></span> Searching...</td></tr>`;

      try {
        const response = await fetch(url);
        const data = await response.json();
        resultsBody.innerHTML = "";
        (data.results || []).forEach(entry => {
          const uniId = entry.primaryAccession;
          const uniLink = `https://www.uniprot.org/uniprotkb/${uniId}`;
          const proteinName = entry.proteinDescription?.recommendedName?.fullName?.value || "N/A";
          const geneName = entry.genes?.[0]?.geneName?.value || "N/A";
          const organismName = entry.organism?.scientificName || "N/A";

          // Group PDB xrefs by chain/position
          const pdbRefs = (entry.uniProtKBCrossReferences || []).filter(ref => ref.database === "PDB");
          const grouped = {};
          pdbRefs.forEach(ref => {
            const chainPos = (ref.properties || []).find(p => p.key === "Chains")?.value || "Unspecified";
            if (!grouped[chainPos]) grouped[chainPos] = [];
            grouped[chainPos].push(ref.id);
          });

          let pdbListHtml = "";
          Object.entries(grouped).forEach(([pos, pdbIds], idx) => {
            const collapseId = `${uniId}-pdb-${idx}`;
            const links = pdbIds.map(pdbId => {
              const rcsbLink = `https://www.rcsb.org/structure/${pdbId}`;
              const detailsId = `${collapseId}-details-${pdbId}`;
              return `
                <div class="mb-2">
                  <strong>${pdbId}</strong>
                  [<a class="link" href="${rcsbLink}" target="_blank">RCSB</a>]
                  <button class="btn btn-sm btn-outline-info ms-2" onclick="checkPDB('${pdbId}', '${detailsId}')">Title</button>
                  <div id="${detailsId}" class="small-text mt-1"></div>
                </div>
              `;
            }).join("");
            pdbListHtml += `
              <div class="pdb-group">
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                  ${pos}
                </button>
                <div id="${collapseId}" class="collapse mt-2">${links}</div>
              </div>`;
          });
          if (!pdbListHtml) pdbListHtml = `<span class="muted">No PDB structures</span>`;

          const seqBtn = `<button class="btn btn-sm btn-info" onclick="showSequence('${uniId}')">View Sequence</button>`;
          const crossLinks = `
            <a class="link" href="https://www.proteinatlas.org/search/${geneName}" target="_blank">HPA</a> |
            <a class="link" href="https://string-db.org/search?query=${geneName}" target="_blank">STRING</a> |
            <a class="link" href="https://www.ensembl.org/Homo_sapiens/Gene/Summary?g=${geneName}" target="_blank">Ensembl</a> |
            <a class="link" href="https://www.ncbi.nlm.nih.gov/gene/?term=${geneName}" target="_blank">NCBI Gene</a>`;

          const row = `<tr>
            <td><a class="link" href="${uniLink}" target="_blank">${uniId}</a></td>
            <td>${proteinName}</td>
            <td>${geneName}</td>
            <td>${organismName}</td>
            <td>${pdbListHtml}</td>
            <td>${seqBtn}</td>
            <td>${crossLinks}</td>
          </tr>`;
          resultsBody.innerHTML += row;
        });

        document.getElementById('resultsTable').classList.remove('d-none');
        if (!(data.results || []).length) {
          resultsBody.innerHTML = `<tr><td colspan="7" class="text-center muted">No results found.</td></tr>`;
        }
      } catch (err) {
        resultsBody.innerHTML = `<tr><td colspan="7" class="text-danger">Error fetching results. Please try again.</td></tr>`;
      }
    });

    // Show UniProt sequence in modal (FASTA)
    async function showSequence(uniId) {
      const seqUrl = `https://rest.uniprot.org/uniprotkb/${uniId}.fasta`;
      const pre = document.getElementById('sequenceContent');
      pre.textContent = "Loading sequence...";
      try {
        const fasta = await fetch(seqUrl).then(r => r.text());
        pre.textContent = fasta || "No sequence available.";
      } catch (err) {
        pre.textContent = "Failed to load sequence.";
      }
      const modal = new bootstrap.Modal(document.getElementById('sequenceModal'));
      modal.show();
    }

    // Fetch only the PDB title from RCSB and display it
    async function checkPDB(pdbId, targetId) {
      const target = document.getElementById(targetId);
      if (!target) return;
      target.innerHTML = `Fetching title <span class="spinner"></span>`;

      try {
        const url = `https://data.rcsb.org/rest/v1/core/entry/${pdbId}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("RCSB response not OK");
        const data = await res.json();

        const title = data.struct?.title || "No title available";
        target.innerHTML = `<div><strong>Title:</strong> ${title}</div>`;
      } catch (err) {
        target.innerHTML = `<span class="text-danger">Failed to fetch title for ${pdbId}.</span>`;
      }
    }
  </script>

</body>
</html>
